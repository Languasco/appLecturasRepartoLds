
@using DSIGE
@using DSIGE.Modelo
@using DSIGE.Negocio

@{
    ViewBag.Title = ".:: Consulta de Reparto  ::.";
    Layout = "~/Views/Shared/_LayoutPrincipal.cshtml";
}

@section instances{

    @Styles.Render("~/Content/dataTables-bootstrap/css/dataTables.bootstrap.min.css")
    @Scripts.Render("~/Content/dataTables-bootstrap/js/jquery.dataTables.min.js")
    @Scripts.Render("~/Content/dataTables-bootstrap/js/dataTables.bootstrap.min.js")

    @Styles.Render("~/Content/bootstrap-datepicker/css/bootstrap-datepicker.min.css")
    @Scripts.Render("~/Content/bootstrap-datepicker/js/bootstrap-datepicker.min.js")
    @Scripts.Render("~/Content/bootstrap-datepicker/locales/bootstrap-datepicker.es.min.js")

    @Scripts.Render("~/Content/bootstrap/js/bootstrap-filestyle.min.js")
    @Scripts.Render("~/Scripts/jquery.fileDownload.js")
    @Scripts.Render("~/Content/angular/angular.js")

    <script src="~/Content/jQueryRotate/jQueryRotate.js"></script>

}

@section styles{
    <style type="text/css">
        .nav-tabs {
            border-bottom: 0;
        }

        #_archivo.btn-info {
            background-image: none;
            color: inherit;
            background-color: inherit !important;
        }

        .datepicker {
            width: 200px;
        }

        body {
            font-size: 10.5px;
            font-family: tahoma;
        }

        .label-primary {
            background-color: #337ab7;
            font-size: 11px;
        }

        .label-danger {
            background-color: red;
            font-size: 11px;
        }

        .resaltado {
            color: red;
            text-decoration: underline;
        }

        .julio .table, th {
            background-color: #333 !important;
            color: white !important;
        }


        .menuBoton, .ul .li {
            list-style-type: none;
            padding: 10px;
            /*display: inline-table;*/
            width: 200px !important;
        }

        .ui-pnotify-text {
            display: block;
            font-size: 13px !important;
            font-weight: bold
        }

        #Principal {
            width: 700px;
            height: 500px;
        }

        .modal {
            z-index: 2000 !important;
        }

        span.label.label-info {
            font-size: 12px !important;
        }

        .tableFixHeadModal {
            max-height: 700px;
        }

        .tableFixHeadModal {
            overflow-y: auto;
            max-height: 650px;
        }

            .tableFixHeadModal thead th {
                position: sticky !important;
                top: 0;
            }

            .tableFixHeadModal .table tbody tr:hover td, .table tbody tr:hover th, .table tbody tr:hover th a {
                background-color: #ddd !important;
                color: black !important;
            }

        .img-thumbnail {
            width: 100% !important;
            height: 100% !important;
        }

        .list-group {
            margin-bottom: 0px !important;
        }

        .list-group-item {
            padding: 9px 10px !important;
            border-left: 1px solid #2196f3 !important;
        }

        #legend {
            font-family: 'Montserrat', sans-serif !important;
            background: #fff;
            padding: 10px;
            margin: 10px;
            border: 3px solid #000;
        }

        .fullscreen-modal .modal-dialog {
          margin: 0;
          margin-right: auto;
          margin-left: auto;
          width: 100%;
        }
        @@media (min-width: 768px) {
          .fullscreen-modal .modal-dialog {
            width: 750px;
          }
        }
        @@media (min-width: 992px) {
            .fullscreen-modal .modal-dialog {
                width: 970px;
            }
        }
        @@media (min-width: 1200px) {
            .fullscreen-modal .modal-dialog {
                width: 1170px;
            }
        }


    </style>
}

@section scripts{

    <script type="text/javascript">


        function filterFloat(evt, input) {
            var key = window.Event ? evt.which : evt.keyCode;


            var chark = String.fromCharCode(key);
            var tempValue = input.value + chark;
            if (key >= 48 && key <= 58) {
                if (filter(tempValue) === false) {
                    return false;
                } else {
                    return true;
                }
            } else {
                if (key == 8 || key == 13 || key == 0) {
                    return true;
                } else if (key == 46) {
                    if (filter(tempValue) === false) {
                        return false;
                    } else {
                        return true;
                    }
                } else {
                    return false;
                }
            }
        }
        function filter(__val__) {
            var preg = /^([0-9]+\:?[0-9]{0,2})$/;
            if (preg.test(__val__) === true) {
                return true;
            } else {
                return false;
            }

        }

    </script>

    <script type="text/javascript">

        $(function () {
            setTimeout(function () {
                $(".select2").select2();
            }, 0);
        });

        var app = angular.module('MyApp', []).directive('onFinishRender', function ($timeout) {
            return {
                restrict: 'A',
                link: function (scope, element, attr) {
                    if (scope.$last === true) {
                        $timeout(function () {
                            scope.$emit('ngRepeatFinished');
                        });
                    }
                }
            }
        }).directive('fileModel', ['$parse', function ($parse) {
            return {
                restrict: 'A',
                link: function (scope, element, attrs) {
                    var model = $parse(attrs.fileModel);
                    var modelSetter = model.assign;

                    element.bind('change', function () {
                        scope.$apply(function () {
                            modelSetter(scope, element[0].files[0]);
                        });
                    });
                }
            };
        }]);

        app.service('fileUpload', ['$http', function ($http) {
            this.uploadFileToUrl = function (idlocal, file, uploadUrl) {

                var fd = new FormData();
                fd.append('file', file);
                fd.append('idlocal', idlocal);
                $http.post(uploadUrl, fd, {

                    transformRequest: angular.identity,
                    headers: { 'Content-Type': undefined }
                })
                    .success(function (data) {

                    })
                    .error(function () {

                    });

            }
        }]);

        app.controller('MyController', function ($scope, $timeout, $http, fileUpload) {

            function MostrandoFechaSistemaActual() {
                var fecha = new Date();
                var ano = fecha.getFullYear();
                var dia = fecha.getDate();
                var mes = fecha.getMonth();

                if (dia < 10) {
                    dia = '0' + dia;
                }
                if (mes <= 9) {
                    mes = '0' + (mes + 1);
                } else {
                    mes = (mes + 1);
                }
                return dia + '/' + mes + '/' + ano
            }

            const mesesGeneral = () => {
                return [{ mes: 1, valor: 'Enero' }, { mes: 2, valor: 'Febrero' }, { mes: 3, valor: 'Marzo' }, { mes: 4, valor: 'Abril' }, { mes: 5, valor: 'Mayo' }, { mes: 6, valor: 'Junio' },
                { mes: 7, valor: 'Julio' }, { mes: 8, valor: 'Agosto' }, { mes: 9, valor: 'Setiembre' }, { mes: 10, valor: 'Octubre' }, { mes: 11, valor: 'Nombre' }, { mes: 12, valor: 'Diciembre' },
                ]
            }

            const aniosGeneral = () => {
                return [{ anio: 2020, valor: '2020' }, { anio: 2021, valor: '2021' }, { anio: 2022, valor: '2022' }, { anio: 2023, valor: '2023' }, { anio: 2024, valor: '2024' }, { anio: 2025, valor: '2025' },
                { anio: 2026, valor: '2026' }, { anio: 2027, valor: '2027' }, { anio: 2028, valor: '2028' }, { anio: 2029, valor: '2029' }, { anio: 2030, valor: '2030' }, { anio: 2031, valor: '2031' }
                ]
            }

            $scope.aniosSistema = [];
            $scope.mesesSistema = [];

            $scope.aniosSistema = aniosGeneral();
            $scope.mesesSistema = mesesGeneral();

            const get_anio = () => {
                const anio = new Date().getFullYear();
                return String(anio);
            }
            const get_mes = () => {
                const mes = new Date().getMonth() + 1;
                return String(mes);
            }

            $scope.obj_paramsFormFiltro = {
                anio: '',
                mes: '',
                idCargo: '0',
                idSucursal: '0',
            }

            $scope.inicializarVariables = function () {
                $scope.obj_paramsFormFiltro = {
                    anio: get_anio(),
                    mes: get_mes(),
                    idCargo: '0',
                    idSucursal: '0'
                }
                setTimeout(function () {
                    $('#idAnio').val(get_anio()).trigger('change');
                    $('#idMes').val(get_mes()).trigger('change');
                }, 0);
 

   
            }

            $scope.cargos = [];
            $scope.listando_cargos = function () {
                $('.sige-load').show();
                var variables = {
                    method: 'POST',
                    url: '../AsignaOrdenTrabajo/getCargos',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    }
                }
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        if (res.ok) {
                            $scope.cargos = res.data;
                        } else {
                            alert(JSON.stringify(res.data))
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                        alert('Lo sentimos, Ocurrio un problema, vuelva a intentar.')
                    });
            };
            $scope.listando_cargos();


            $scope.sucursales = [];
            $scope.listando_sucursales = function () {
                $('.sige-load').show();
                var variables = {
                    method: 'POST',
                    url: '../AsignaOrdenTrabajo/getSucursales',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    }
                }
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        if (res.ok) {
                            $scope.sucursales = res.data;
                        } else {
                            alert(JSON.stringify(res.data))
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                        alert('Lo sentimos, Ocurrio un problema, vuelva a intentar.')
                    });
            };
            $scope.listando_sucursales();

            $scope.operarios = [];
            $scope.listando_operarios = function () {
                $('.sige-load').show();
                var variables = {
                    method: 'POST',
                    url: '../AsignaOrdenTrabajo/getOperarios',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    }
                }
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        if (res.ok) {
                            $scope.operarios = res.data;
                        } else {
                            alert(JSON.stringify(res.data))
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                        alert('Lo sentimos, Ocurrio un problema, vuelva a intentar.')
                    });
            };
            $scope.listando_operarios();


            $scope.supervisores = [];
            $scope.listando_Supervisores = function () {
                $('.sige-load').show();
                var variables = {
                    method: 'POST',
                    url: '../AsignaOrdenTrabajo/getSupervisores',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    }
                }
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        if (res.ok) {
                            $scope.supervisores = res.data;
                        } else {
                            alert(JSON.stringify(res.data))
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                        alert('Lo sentimos, Ocurrio un problema, vuelva a intentar.')
                    });
            };
            $scope.listando_Supervisores();

            const validacionesFiltros = () => {
                if ($scope.obj_paramsFormFiltro.anio == 0 || $scope.obj_paramsFormFiltro.anio == '0') {
                    new PNotify({
                        title: 'Sistemas',
                        text: 'Seleccione el Año.',
                        type: 'error'
                    });
                    return false;
                }

                if ($scope.obj_paramsFormFiltro.mes == 0 || $scope.obj_paramsFormFiltro.mes == '0') {
                    new PNotify({
                        title: 'Sistemas',
                        text: 'Por favor seleccione el Mes',
                        type: 'error'
                    });
                    return false;
                }

                if ($scope.obj_paramsFormFiltro.idCargo == 0 || $scope.obj_paramsFormFiltro.idCargo == '0') {
                    new PNotify({
                        title: 'Sistemas',
                        text: 'Por favor seleccione el Cargo',
                        type: 'error'
                    });
                    return false;
                }
            }

            $scope.repartosCab = [];
            $scope.mostrandoInformacion_consultaRepartosCab = function () {

                if (validacionesFiltros() == false) {
                    return;
                }

                $('.sige-load').show();
                var variables = {
                    method: 'POST',
                    url: '../AsignaOrdenTrabajo/getConsultaRepartoCab',
                    data: {
                        anio: $scope.obj_paramsFormFiltro.anio,
                        mes: $scope.obj_paramsFormFiltro.mes,
                        idCargo: $scope.obj_paramsFormFiltro.idCargo,
                        idSucursal: $scope.obj_paramsFormFiltro.idSucursal,
                    },
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    }
                }
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        if (res.ok) {
                            $scope.repartosCab = res.data;
                        } else {
                            alert(JSON.stringify(res.data))
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                        alert('Lo sentimos, Ocurrio un problema, vuelva a intentar.')
                    });
            };


            // METODO PARA CHEKED ALL
            $scope.checkedAll = false;
            $scope.checkedAll_OrdenTrabajo = function (checked) {
                if (checked) {
                    angular.forEach($scope.repartosCab, function (child) {
                        child.checkeado = true;
                    })
                } else {
                    angular.forEach($scope.repartosCab, function (child) {
                        child.checkeado = false;
                    })
                }
            }

            function MarcoCheck() {
                var flag_marco = false;
                for (var i = 0; i < $scope.repartosCab.length; i++) {
                    if ($scope.repartosCab[i].checkeado == true) {
                        flag_marco = true;
                        break;
                    }
                }
                return flag_marco;
            }

            function ListaMarcoCheck() {
                $scope.ListaData = [];
                for (var i = 0; i < $scope.repartosCab.length; i++) {
                    if ($scope.repartosCab[i].checkeado == true) {
                        $scope.ListaData.push({
                            'sucursal': $scope.repartosCab[i].sucursal,
                            'zona': $scope.repartosCab[i].zona,
                        });
                    }
                }
                return $scope.ListaData;
            }

            $scope.tituloModal = '';
            $scope.esOperario = false;


            $scope.GenerarFinalizarReparto = function () {

                if (validacionesFiltros() == false) {
                    return;
                }

                (new PNotify({
                    title: 'Sistemas Confirmación ',
                    text: 'Esta seguro de Finalizar el Reparto ?',
                    icon: 'glyphicon glyphicon-question-sign',
                    hide: false,
                    confirm: {
                        confirm: true
                    },
                    buttons: {
                        closer: false,
                        sticker: false
                    },
                    history: {
                        history: false
                    }
                })).get().on('pnotify.confirm', function () {

                    $('.sige-load').show();
                    var variables = {
                        method: 'POST',
                        url: '../AsignaOrdenTrabajo/setfinalizarReparto',
                        data: {
                            anio: $scope.obj_paramsFormFiltro.anio,
                            mes: $scope.obj_paramsFormFiltro.mes,
                            idCargo: $scope.obj_paramsFormFiltro.idCargo,
                            idSucursal: $scope.obj_paramsFormFiltro.idSucursal,
                        },
                        headers: {
                            'Content-Type': 'application/json; charset=utf-8'
                        }
                    }
                    $http(variables)
                        .success(function (res) {
                            $('.sige-load').hide();
                            if (res.ok == true) {
                                new PNotify({
                                    title: 'Sistemas',
                                    text: 'Proceso Realizado Correctamente.',
                                    type: 'success'
                                });
                                $scope.mostrandoInformacion_consultaRepartosCab();                                 
                            } else {
                                alert(JSON.stringify(res.data))
                            }
                        })
                        .error(function () {
                            alert('Ocurrio un problema con la conexion, vuelva a intentar.')
                        });


                }).on('pnotify.cancel', function () {

                });

            }

            $scope.doSearch = function () {

                let tableReg = null;
                let searchText = null;

                tableReg = document.getElementById('tblLista');
                searchText = document.getElementById('inputSearch_user').value.toLowerCase();



                for (var i = 1; i < tableReg.rows.length; i++) {
                    var cellsOfRow = tableReg.rows[i].getElementsByTagName('td');
                    var found = false;
                    for (var j = 0; j < cellsOfRow.length && !found; j++) {
                        var compareWith = cellsOfRow[j].innerHTML.toLowerCase();
                        if (searchText.length == 0 || (compareWith.indexOf(searchText) > -1)) {
                            found = true;
                        }
                    }
                    if (found) {
                        tableReg.rows[i].style.display = '';
                    } else {
                        tableReg.rows[i].style.display = 'none';
                    }
                }
            }

            $scope.exportarConsultaReparto = function () {

                if (validacionesFiltros() == false) {
                    return;
                }

                $('.sige-load').show();
                var variables = {
                    method: 'POST',
                    url: '../AsignaOrdenTrabajo/getExportar_consultaReparto',
                    data: {
                        anio: $scope.obj_paramsFormFiltro.anio,
                        mes: $scope.obj_paramsFormFiltro.mes,
                        idCargo: $scope.obj_paramsFormFiltro.idCargo,
                        idSucursal: $scope.obj_paramsFormFiltro.idSucursal,
                    },
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    }
                }
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        console.log(res);
                        if (res.ok) {
                            window.open(res.data, '_blank');
                        } else {
                            alert(JSON.stringify(res.data))
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                        alert('Lo sentimos, Ocurrio un problema, vuelva a intentar.')
                    });
            };


            $scope.abrirModal_libro = function (item) { 
                $scope.mostrandoSuministrosAsignados(item);
            }

            $scope.suministrosAsignador = [];
            $scope.mostrandoSuministrosAsignados = function (item) {

                if (validacionesFiltros() == false) {
                    return;
                }

                $scope.suministrosAsignador = [];

                $('.sige-load').show();
                var variables = {
                    method: 'POST',
                    url: '../AsignaOrdenTrabajo/getSuministrosAsignados',
                    data: {
                        anio: $scope.obj_paramsFormFiltro.anio,
                        mes: $scope.obj_paramsFormFiltro.mes,
                        idCargo: $scope.obj_paramsFormFiltro.idCargo,
                        idSucursal: item.sucursal,
                        zona: item.zona
                    },
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    }
                }
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        if (res.ok) {
                            $scope.suministrosAsignador = res.data;

                            setTimeout(function () {
                                $('#modal_libro').modal({ show: 'false' });
                            }, 0);

                        } else {
                            alert(JSON.stringify(res.data))
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                        alert('Lo sentimos, Ocurrio un problema, vuelva a intentar.')
                    });
            };

            //------ gogoole maps ----


            $scope.markers = [];
            let ContenidoMarker = '';
            let icono = '';
            let titulo = '';
            let id_marker = 0;
            var infoWindow;

            function RemoveMarker(map) {
                for (var i = 0; i < $scope.markers.length; i++) {
                    $scope.markers[i].setMap(map);
                }
            }


            const iconosLeyendas = () => {

                var legend = null;

                const icons = {
                    Suministro: {
                        name: 'Suministro',
                        icon: '../Content/Imagen/icon_blue.png',
                    },
                    Sum_Pendiente: {
                        name: 'Suministro Pendiente',
                        icon: '../Content/Imagen/sum_pendiente.png',
                    },
                    Sum_Foto: {
                        name: 'Suministro Foto',
                        icon: '../Content/Imagen/camara.png',
                    },
                };

                 legend = document.getElementById('legend');

                //console.log(legend)
                //if (legend == null) {
                //    alert('entroo')
                //    const div = document.createElement("div");
                //    div.setAttribute("id", "legend");   // Vuelve a añadir id="page"


                //    console.log(div)

                //    legend = document.getElementById('legend');
                //}

 
                for (var key in icons) {

                    const type = icons[key];
                    const name = type.name;
                    const icon = type.icon;

                    let div = document.createElement('div');

                    if (name == 'Suministro') {
                        div.innerHTML = '<img src="' + icon + '" style=" margin-left: -5px;"> ' + name;
                    }
                    else if (name == 'Suministro Foto') {
                        div.innerHTML = '<img src="' + icon + '" style=" margin-left: 0px;"> ' + name;
                    }
                    else if (name == 'Suministro Pendiente') {
                        div.innerHTML = '<img src="' + icon + '" style=" margin-left: -4px;"> ' + name;
                    }
                    else {
                        div.innerHTML = '<img src="' + icon + '"> ' + name;
                    }
                    legend.appendChild(div);
                }

                legend.style.cssText = 'color: black;font-weight: 800; margin-left: 10px!important ; margin-top: 10px !important;';


                $scope.map.controls[google.maps.ControlPosition.TOP_LEFT].push(legend);

 

            }



            function InicializarMapaGlobal() {

                infoWindow = new google.maps.InfoWindow();

                $scope.map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 11,
                    center: { lat: -12.046374, lng: -77.0427934 },
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_CENTER
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.LEFT_CENTER
                    },
                    scaleControl: true,
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.LEFT_TOP
                    }
                });
                setTimeout(function () {
                    iconosLeyendas()
                }, 0);
 
            };

            function InicializarMapa() {

                infoWindow = new google.maps.InfoWindow();

                $scope.map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 11,
                    center: { lat: -12.046374, lng: -77.0427934 },
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_CENTER
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.LEFT_CENTER
                    },
                    scaleControl: true,
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.LEFT_TOP
                    }
                });
 
            };

            $scope.limpiarMapa = function () {
                RemoveMarker(null);
                $scope.markers = [];
            }

            $scope.openInfoWindow = function (e, selectedMarker) {
                e.preventDefault();
                google.maps.event.trigger(selectedMarker, 'click');
            }


            $scope.abrilModal_mapa = function (item) {

                if (validacionesFiltros() == false) {
                    return;
                }

                setTimeout(function () {
                    /*      $('#modal_mapa').modal({ show: 'true' });*/
                    $("#modal_mapa").modal("show");
                    $("#map").css("width", "100%");

                    InicializarMapaGlobal();

                }, 0);

                $scope.ubicacionSuministros(item)

 
            }


            $scope.ubicacionSuministros = function (item) {
                var variables = {
                    method: 'POST',
                    url: '../Ubicacion_Operarios/get_ubicacionSuministro_operario',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    data: {
                        anio: $scope.obj_paramsFormFiltro.anio,
                        mes: $scope.obj_paramsFormFiltro.mes,
                        idCargo: $scope.obj_paramsFormFiltro.idCargo,
                        idSucursal: item.sucursal,
                        zona: item.zona,
                        idOperario: item.id_Operario_Reparto,
                    }
                }
                $('.sige-load').show();
                $http(variables)
                    .success(function (res) {
                        $('.sige-load').hide();
                        if (res.ok) {
                            if (res.data.length > 0) {
                                MostrarUbicacionSuministro(res.data);
                            } else {
                                new PNotify({
                                    title: 'Sistemas',
                                    text: 'No hay información de las Ubicaciones del Cliente.',
                                    type: 'success'
                                });
                            }
                        } else {
                            alert(JSON.stringify(res.data));
                        }
                    })
                    .error(function () {
                        $('.sige-load').hide();
                    });
            }


            function MostrarUbicacionSuministro(obj_Lista) {

                $scope.markers = [];
                for (var i = 0; i < obj_Lista.length; i++) {
                    createMarker_Suministros(obj_Lista[i]);
                }
            }

            var createMarker_Suministros = function (info) {

                ContenidoMarker = '';
                ContenidoMarker += '<div id="_market" style="width:450px;height:110px;position:relative;">';
                ContenidoMarker += '<table><tr><td><strong >Suministro</strong></td><td>: ' + info.suministro + '</td></tr>';
                ContenidoMarker += '<tr><td><strong>Dirección</strong></td><td>: ' + info.direccion + '</td></tr>';
                ContenidoMarker += '<tr><td><strong>Distrito</strong></td><td>: ' + info.distrito + '</td></tr>';
                ContenidoMarker += '<tr><td><strong>Cliente </strong></td><td>: ' + info.cliente + '</td></tr>';
                ContenidoMarker += '<tr><td><strong>Operador </strong></td><td>: ' + info.operario + ' </td></tr>';
                if (info.tieneFoto == 'SI') {
                    ContenidoMarker += '<tr><td colspan="2" style="text-align:center;"><strong><a onclick="galeriaFotosSuministro(' + info.id_Reparto + ');" href="#">Ver Foto Suministro</a></strong></td></tr>';
                }
                ContenidoMarker += '</table>';
                ContenidoMarker += '</div>';
                 
                if (info.estado == '7' || info.estado == '8') {
                    icono = '../Content/Imagen/icon_blue.png',
                        titulo = 'SUMINISTRO';
                }
                else if (info.estado == '5' || info.estado == '5') {
                    icono = '../Content/Imagen/sum_pendiente.png',
                        titulo = 'SUMINISTRO NO VISITADO';
                }
                else {
                    icono = '../Content/Imagen/camara.png',
                        titulo = 'SUMINISTRO CON FOTO';
                }


                var marker = new google.maps.Marker({
                    map: $scope.map,
                    position: new google.maps.LatLng(info.latitud, info.longitud),
                    title: titulo,
                    icon: icono,
                    content: ContenidoMarker,
                    optimized: false,
                    id: ++id_marker,
                });

                google.maps.event.addListener(marker, 'click', function () {
                    infoWindow.setContent('<center><h4><b>' + marker.title + '</b></h4></center>' +
                        marker.content);
                    infoWindow.open($scope.map, marker);
                });
                $scope.markers.push(marker);

            }

        });


        var degrees = 0;
        function rotateImg() {
            degrees += 90;
            console.log($('#imgRotate'));
            $("#imgRotate").rotate(degrees);
        }

        var listPhotos = [];
        var posicionActual = 0;

        function previusPhoto() {
            var photo1 = document.getElementById('imgRotate');

            if (posicionActual <= 0) {
                posicionActual = listPhotos.length - 1;
            } else {
                posicionActual--;
            }
            photo1.src = listPhotos[posicionActual].url;
        }

        function nextPhoto() {
            var photo1 = document.getElementById('imgRotate');

            if (posicionActual >= listPhotos.length - 1) {
                posicionActual = 0;
            } else {
                posicionActual++;
            }
            if (listPhotos.length > 1) {
                photo1.src = listPhotos[posicionActual].url;
            }
        }

        function galeriaFotosSuministro(idReparto) {

            let anio = document.getElementById('idAnio').value;
            let mes = document.getElementById('idMes').value;
            let sector = document.getElementById('idCargo').value;

            if (anio == 0 || anio == '0') {
                new PNotify({
                    title: 'Sistemas',
                    text: 'Seleccione el Año.',
                    type: 'error'
                });
                return;
            }

            if (mes == 0 || mes == '0') {
                new PNotify({
                    title: 'Sistemas',
                    text: 'Por favor seleccione el Mes',
                    type: 'error'
                });
                return;
            }

            if (sector == 0 || sector == '0') {
                new PNotify({
                    title: 'Sistemas',
                    text: 'Por favor seleccione el Cargo',
                    type: 'error'
                });
                return;
            }

            posicionActual = 0;

            $.ajax({
                async: true,
                beforeSend: function (xhr) { },
                url: '../Ubicacion_Operarios/get_fotosSuministros',
                type: 'POST',
                dataType: 'json',
                data: {
                    idReparto: idReparto,
                    anio: anio,
                    mes: mes,
                    idCargo: sector,
                },
                success: function (res) {

                    $("div").remove("#x");
                    var $DivCorre = $('#corre');

                    $('#fotos').modal();

                    if (res.ok) {
                        listPhotos = [];
                        $.each(res.data, function (i, v) {
                            listPhotos.push({
                                id: i,
                                url: res.data[i].url
                            })
                        });
                        $DivCorre.append('<div id="x" class="item active"><img id="imgRotate" src="' + listPhotos[0].url + '" alt="..." style="width: 600px; height: 600PX; text-align: center;" /></div>');
                    } else {
                        alert(JSON.stringify(res.data))
                    }
                },
                error: function (xhr) {
                    alert('Algo salió mal, por favor intente de nuevo.');
                }
            });
        }

    </script>
}

<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
</head>

<body>

    <div ng-app="MyApp" ng-controller="MyController" ng-init="inicializarVariables()">
        <div class="panel panel-oscuro ">
            <div class="panel-heading">
                <h6><i class="fa fa-table fa-lg"></i> CONSULTA DE REPARTO DE LIBROS </h6>
            </div>
            <div class="panel-body">

                <div class="row">
                    <div class="col-xs-6 col-sm-2 col-md-2">
                        <label for="idAnio" class="control-label">Año</label>
                        <br />
                        <select class=" select2" id="idAnio" style="width:98%" ng-model="obj_paramsFormFiltro.anio">
                            <option value="0" selected="selected"> [-SELEC-]</option>
                            <option ng-repeat="item in aniosSistema" value="{{item.anio}}"> {{item.valor}} </option>
                        </select>
                    </div>
                    <div class="col-xs-6 col-sm-2 col-md-2">
                        <label for="idMes" class="control-label">Mes</label>
                        <br />
                        <select class="select2" id="idMes" style="width:98%" ng-model="obj_paramsFormFiltro.mes">
                            <option value="0" selected="selected"> [-SELEC-]</option>
                            <option ng-repeat="item in mesesSistema" value="{{item.mes}}"> {{item.valor}} </option>
                        </select>
                    </div>

                    <div class="col-xs-6 col-sm-2 col-md-2">
                        <label for="idCargo" class="control-label">Cargo</label>
                        <br />
                        <select class=" select2" id="idCargo" style="width:98%" ng-model="obj_paramsFormFiltro.idCargo">
                            <option value="0" selected="selected"> [-SELEC-]</option>
                            <option ng-repeat="item in cargos" value="{{item.id}}"> {{item.descripcion}} </option>
                        </select>
                    </div>
                    <div class="col-xs-6 col-sm-4 col-md-4">
                        <label for="cboSucursal" class="control-label">Sucursal</label>
                        <br />
                        <select class=" select2" id="cboSucursal" style="width:98%" ng-model="obj_paramsFormFiltro.idSucursal">
                            <option value="0" selected="selected"> [--TODOS--]</option>
                            <option ng-repeat="item in sucursales" value="{{item.id}}"> {{item.descripcion}} </option>
                        </select>
                    </div>

                    <div class="col-xs-12  col-sm-2 col-md-2">
                        <br />
                        <div class="text-center ">
                            <button button id="btn_buscar" class="btn btn-block btn-primary btn-sm" ng-click="mostrandoInformacion_consultaRepartosCab()"><span class="glyphicon glyphicon-search"></span> Buscar </button>
                        </div>
                    </div>
                </div>
                <br />
                <div class="row">
                    <div class="col-md-12 ">
                        <div class=" text-center">
                            <button button id="btn_exportar" class="btn btn-success btn-sm" ng-click="exportarConsultaReparto()"><span class="glyphicon glyphicon-download"></span> Exportar </button>
                            <button button id="btn_exportar" class="btn btn-warning btn-sm"  ><span class="glyphicon glyphicon-download"></span> Exportar Detalle </button>
                            <button button id="btn_exportar" class="btn btn-info btn-sm" ng-click="GenerarFinalizarReparto()"><span class="glyphicon glyphicon-download"></span> Finalizar Reparto </button>
                        </div>

                    </div>
                </div>

                <hr />

                <div class="row" style=" margin-top: -10px; margin-bottom: 5px;">
                    <div class="col-sm-3">

                    </div>
                    <div class="col-sm-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-addon">Buscar</span>
                            <input id="inputSearch_user" type="text" ng-keyup="doSearch()" placeholder="Busqueda Usuarios . . " style="width:95%" class="form-control btn-block inputSearch" autocomplete="off">
                        </div>
                    </div>
                    <div class="col-sm-3">

                    </div>
                </div>

                <div class="tableFixHead">
                    <table id="tblLista" class="table  table-bordered  ">
                        <thead>
                            <tr>
                                @*<th>
            <div class="checkbox clip-check check-danger checkbox-inline" style=" margin-bottom: -5px;">
                <input type="checkbox" id="checkboxAll" value="1" ng-model="checkedAll" ng-click="checkedAll_OrdenTrabajo(checkedAll,1)">
                <label for="checkboxAll">
                </label>
            </div>
        </th>*@
                                <th>Sucursal</th>
                                <th>Zona</th>
                                <th>Repartidor</th>

                                <th>Total Libro</th>
                                <th>Ordinarios</th>

                                <th>Ord. Rep</th>
                                <th>Ord. % Rep</th>
 

                                <th>Reclamos</th>
                                <th>Rec. Rep</th>
                                <th>Rec. % Rep</th>

                                <th>Supervisor</th>
                                <th>Supervisado</th>
                                <th>% Supervisado </th>
                                <th>Inicio Reparto</th>
                                <th>Fin Reparto</th>

                                <th>Ver Libro</th>
                                <th>Plazo </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="item in repartosCab">
                                @*<td>
            <div class="checkbox clip-check check-primary checkbox-inline" style="margin-bottom: -13px !important;   margin-top: -19px;">
                <input type="checkbox" id="checkbox{{$index}}" value="true" ng-disabled={{item.disabled}} ng-model="item.checkeado">
                <label for="checkbox{{$index}}">
                </label>
            </div>
        </td>*@
                                <td>{{item.sucursal}}</td>
                                <td>{{item.zona}}</td>
                                <td class="text-center" ng-click="abrilModal_mapa(item);" style="text-decoration: underline green; cursor:pointer">
                                    {{item.operario}}      <img src="../Content/Imagen/mapa.png" title="Ver Mapa" style="cursor:pointer ">
                                </td>
                                <td style="text-align:right">{{item.totalLibro}}</td>
                                <td style="text-align:right">{{item.ordinario}}</td>

                                <td style="text-align:right">{{item.ordinarioRep}}</td>
                                <td style="text-align:right">{{item.ordinarioPorcRep}}</td>


                                <td style="text-align:right">{{item.reclamos}}</td>
                                <td style="text-align:right">{{item.recRep}}</td>
                                <td style="text-align:right">{{item.recPorcentajeRep}}</td>

                                <td>{{item.supervisor}}</td>
                                <td>{{item.supervisado}}</td>
                                <td>{{item.porcSupervisado}}</td>
                                <td>{{item.inicioReparto}}</td>
                                <td>{{item.finReparto}}</td>

                                <td style="text-align:center">
                                    <img src="../Content/Imagen/foto.png" ng-show="item.verLibro == 'SI' ? true: false" title="Ver Libro" style="cursor:pointer " ng-click="abrirModal_libro(item);">
                                </td>
                                <td>{{item.plazo}}</td>


                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>


        <div id="modal_libro" class="modal fade" role="dialog" tabindex="-1" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-lg">
                <div class="panel panel-oscuro">
                    <div class="panel-heading">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h6 class="modal-title"><i class="fa fa-calendar fa-lg"></i> SUMINISTROS ASIGNADOS </h6>
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal">


                            <div class="tableFixHeadModal">
                                <table id="tblLista" class="table  table-bordered  ">
                                    <thead>
                                        <tr>

                                            @*<th>Ruta</th>
                                                <th>Servicio</th>
                                                <th>Suministro</th>
                                                <th>Direccion</th>
                                                <th>Cliente</th>
                                                <th>Fecha Hora Recep</th>
                                                <th>Supervisar</th>
                                                <th>Supervisor</th>
                                                <th>Estado Supervision</th>
                                                <th>Fecha Hora Sup.</th>*@
                                            <th>Datos Generales</th>
                                            <th>Imagen</th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in suministrosAsignador">
                                            @*<td>{{item.sucursal}}</td>
                                                <td>{{item.zona}}</td>
                                                <td>{{item.operario}}</td>
                                                <td style="text-align:right">{{item.totalLibro}}</td>
                                                <td style="text-align:right">{{item.ordinario}}</td>
                                                <td style="text-align:right">{{item.reclamos}}</td>
                                                <td style="text-align:right">{{item.recRep}}</td>
                                                <td style="text-align:right">{{item.recPorcentajeRep}}</td>
                                                <td>{{item.supervisor}}</td>
                                                <td>{{item.supervisado}}</td>*@
                                            <td>
                                                <ul class="list-group">
                                                    <li class="list-group-item">  <label class="control-label">Ruta :  </label>  {{item.ruta}}</li>
                                                    <li class="list-group-item"> <label class="control-label">Servicio :  </label>  {{item.servicio}} </li>
                                                    <li class="list-group-item"> <label class="control-label">Suministro :  </label>   {{item.suministro}}      </li>
                                                    <li class="list-group-item"> <label class="control-label">Direccion :  </label>  {{item.direccion}}   </li>
                                                    <li class="list-group-item"> <label class="control-label">Cliente :  </label>  {{item.cliente}} </li>
                                                    <li class="list-group-item"> <label class="control-label">Fecha Hora Recep :  </label>   {{item.fechaHoraRep}} </li>
                                                    <li class="list-group-item"> <label class="control-label">Supervisar :  </label>  {{item.supervisar}} </li>
                                                    <li class="list-group-item"> <label class="control-label">Supervisor :  </label>  {{item.supervisor}} </li>
                                                    <li class="list-group-item"> <label class="control-label">Estado Supervision :  </label>  {{item.estadoSupervision}} </li>
                                                    <li class="list-group-item"> <label class="control-label">Fecha Hora Sup. :  </label>    {{item.fechaHoraSupervision}} </li>
                                                </ul>
                                            </td>
                                            <td style="text-align:center">
                                                <div style="width:400px; height: 400px">
                                                    <img src={{item.urlImagen}} alt="..." class="img-thumbnail">
                                                </div>
                                                <br />
                                                {{$index+1}}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>



                        </div>
                    </div>
                    <div class="panel-footer">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="btn-group btn-group-sm" role="group" aria-label="Mantenimiento" style="float: right;">
                                    <button id="btn_cancelImportar" role="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-close fa-lg"></i> Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fullscreen-modal fade" id="modal_mapa" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Ubicación del Suministro</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12 modal_body_map">
                                <div class="location-map" id="location-map">
                                    <div style="width: 600px; height: 400px;" id="map">
                                        <div id="legend" style="margin-top : 15px ; margin-left: 5px"> </div>
                                    </div>
                                </div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                                <div id="legend" style="margin-top : 15px ; margin-left: 5px ; display:none"><h3></h3></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div id="fotos" class="modal fade bd-example-modal-lg " tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="myLargeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" style=" width: 600px;">
                <div class="panel panel-oscuro">
                    <div class="panel-heading">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <a onclick="rotateImg();" class="pull-right rotate" style="    margin-top: -10px; font-size: 12px; padding: 3px 4px;  color: white;  margin-right: 20px;cursor:pointer"><i class="fa fa-repeat" style="Color:#337ab7; font-size: 30px" aria-hidden="true"></i>Girar</a>
                        <h6 class="modal-title" style=" font-size: 11px;"><i class="fa fa-cogs fa-lg"></i> DETALLE DE FOTOS</h6>
                    </div>
                    <div class="panel-body">
                        <fieldset>
                            <legend></legend>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                                        <div class="carousel-inner" id="corre">
                                        </div>

                                        <a class="left carousel-control" href="#carousel-example-generic" onclick="previusPhoto()" role="button" data-slide="prev" style="background-color:black;width: 5px;">
                                            <span class="glyphicon glyphicon-chevron-left"></span>
                                        </a>
                                        <a class="right carousel-control" href="#carousel-example-generic" onclick="nextPhoto()" role="button" data-slide="next" style="background-color:black; width: 5px;">
                                            <span class="glyphicon glyphicon-chevron-right"></span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="panel-footer">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="btn-group btn-group-sm" role="group" aria-label="Mantenimiento" style="float: right;">
                                        <button role="button" id="btnCancelar" class="btn btn-default" style="background-color: #fff;" data-dismiss="modal"><i class="fa fa-close fa-lg"></i> Atras</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
</body>
</html>





